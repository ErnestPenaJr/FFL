<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="assets/css/style.css">
        <link rel="stylesheet" href="assets/fontawesome-pro-5.15.4/css/all.css">
        <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.css">
        <link rel="stylesheet" href="node_modules/datatables.net-bs5/css/dataTables.bootstrap5.css">
        <link rel="stylesheet" href="node_modules/datatables.net-buttons-bs5/css/buttons.bootstrap5.css">
    </head>
    <body>
        <div class="container-fluid">

            <div id="T32" data-table="t32" class="rounded-2"></div>
            
        </div>
        
        <div class="modal fade" id="t32Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">Record <span id="recordID" class="badge bg-primary"></span> Details </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <div class="row">
                            <div class="col-3">
                                <span id="modal-type">
                                    <label for="type" class="form-label fw-bold text-uppercase">Transaction Type</label>
                                    <select name="type" id="type" class="form-control">
                                        <option selected>Select Transaction Type</option>
                                        <option value="Travel">Travel</option>
                                        <option value="M & O">M & O</option>
                                        <option value="Child Care">Child Care</option>
                                    </select>
                                </span>
                            </div>
                            <div class="col">
                                <h2 class="text-center text-uppercase text-black d-block align-content-center">transactions<br><small class="title text-muted fst-italic fs-4 mt-0"></small></h2>
                            </div>
                            <div class="col">
                                <span id="modal-credit">
                                    <label for="credit" class="form-label fw-bold text-uppercase">Credit</label>
                                    <input name="credit" id="credit" type="text" class="form-control" disabled>
                                </span>
                            </div>
                        </div>
                        <hr>
                        <div class="row mb-2">
                            <div class="col">
                                <span id="modal-cfs">
                                    <label for="cfs" class="form-label fw-bold text-uppercase">Chart Field String</label>
                                    <input name="cfs" id="cfs" type="text" class="form-control" disabled>
                                </span>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col">
                                <span id="modal-emplid">
                                        <label for="emplid" class="form-label fw-bold text-uppercase">EMPL<span id="searching">O</span>YEE SEARCH</span></label>
                                        <input name="emplid" id="emplid" type="text" class="form-control" placeholder="Employee ID" disabled />
                                    
                                    <div id="results" style="color:#000;margin-top:5px;max-height: 350px; z-index: 10; position: relative;"></div>
                                </span>
                            </div>
                            <div class="col">  
                                <span id="modal-vendorID">
                                    <label for="vendorID" class="form-label fw-bold text-uppercase">Vendor ID</label>
                                    <input name="vendorID" id="vendorID" type="text" class="form-control" placeholder="Vendor ID" disabled>
                                </span>
                            </div>
                            <div class="col">
                                <span id="modal-vendorname">
                                    <label for="vendorname" class="form-label fw-bold text-uppercase">Vendor Name</label>
                                    <input name="vendorname" id="vendorname" type="text" class="form-control" placeholder="Vendor name" disabled>
                                </span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col">
                                <span id="modal-expensed_date">
                                    <label for="expensed_date" class="form-label fw-bold text-uppercase">Expense Date</label>
                                    <input name="expensed_date" id="expensed_date" type="date" class="form-control" disabled/>
                                </span>
                            </div>
                            <div class="col">
                                <span id="modal-requisition_date">
                                    <label for="requisition_date" class="reqDate form-label fw-bold text-uppercase">Requisition Date</label>
                                    <input name="requisition_date" id="requisition_date" type="date" class="form-control" disabled/>
                                </span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col">
                                <span id="modal-notes">
                                    <label for="notes" class="form-label fw-bold text-uppercase">Description</label>
                                    <textarea name="notes" id="notes" type="text" class="form-control" placeholder="Description" disabled></textarea>
                                </span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col">
                                <span id="modal-debit">
                                    <label for="expense_date" class="form-label fw-bold text-uppercase">Debit / Cost</label>
                                    <input name="debit" id="debit" type="text" class="form-control" disabled />
                                </span>
                            </div>
                            <div class="col">
                                <span id="modal-purchaseMethod">
                                    <label for="purchaseMethod" class="form-label fw-bold text-uppercase">Purchase Method</label>
                                    <div class="row">
                                        <div class="col">
                                            <select id="purchaseMethod" class="form-select " disabled>
                                                <option selected>Select Purchase Method</option>
                                                <option value="PO">PO</option>
                                                <option value="PROCARD">ProCard</option>
                                                <option value="CONCUR">Concur</option>
                                            </select>
                                        </div>
                                        <div class="col">
                                            <input name="po" id="po" type="text" class="form-control" placeholder="Purchase Order" style="display: none;" disabled />
                                        </div>
                                    </div>
                                </span>
                            </div>
                        </div>
                </div>
                <div class="modal-footer">
                  <button id="save" type="button" class="btn btn-primary" style="display:none"><i class="fas fa-save"></i> Save New Record</button>
                  <button id="update" type="button" class="btn btn-success" style="display:none"><i class="fas fa-upload"></i> Update</button>
                  <button id="soft_delete" type="button" class="btn btn-warning" style="display:none"><i class="fas fa-trash"></i> Delete</button>
                  <input type="hidden" id="ID" class="form-control">
                </div>
              </div>
            </div>
          </div>      
        
        <script src="node_modules/jquery/dist/jquery.js"></script>
        <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
        <script src="assets/fontawesome-pro-5.15.4/js/fontawesome.js"></script>
        <script src="node_modules/aos/dist/aos.js"></script>
        <script src="node_modules/datatables.net/js/jquery.dataTables.js"></script>
        <script src="node_modules/datatables.net-bs5/js/dataTables.bootstrap5.js"></script>
        <script src="node_modules/datatables.net-buttons/js/dataTables.buttons.js"></script>
        <script src="node_modules/datatables.net-buttons-bs5/js/buttons.bootstrap5.js"></script>
        <script src="node_modules/xlsx/dist/xlsx.full.min.js"></script>
        <script src="node_modules/moment/moment.js"></script>
        <script src="assets/js/script.js"></script>
    </body>
</html>

<script>
    $(document).ready(function(){
        var type = $("#LoadContent").data("type");
        if(type=='T32'){
            $(".typeName").text(type+'-Checkbook');
            loadT32(type)
        }
        //Employee search function
        $('#emplid').on('keyup', function() {
            $('.returnMessage').removeClass('alert alert-danger').empty() 
            var x = $(this).val();
            
            if (x != '') {
                employeeSearch(x)
            } else {
                $(this).attr('emplid','');
                $('#results').hide();
                $('#addUser').removeClass('btn-warning').addClass('btn-secondary');
                $('#searching').html('O');
            }
        });
        $('#purchaseMethod').on('change', function(){
            if($(this).val() == 'PO'){
                $('#po').slideDown();
            }else{
                $('#po').slideUp();
            }
        });
        //on modal dismiss reset modal fields to default values and set buttons to default
        $('#t32Modal').on('hidden.bs.modal', function (e) {
            $('#recordID').html('');
            $('#ID').val('');
            $('#cfs').val('');
            $('#vendorname').val('');
            $('#vendorID').val('');
            $('#emplid').val('');
            $('#expensed_date').val();
            $('#expensed_date').val('');
            $('#requisition_date').val('');
            $('#notes').val('');
            $('#debit').val('');
            $('#credit').val('');
            $('#type').val('Select Transaction Type');
            $("input").attr("disabled",true);
            $("textarea").attr("disabled",true);
            $("select").attr("disabled",true);
            $('.title').html('');
            $('#soft_delete').removeClass('btn-danger').addClass('btn-warning').html('<i class="fas fa-trash"></i> Delete');
        });
        
        loadT32();

        $('#soft_delete').on('click', function() {
            $(this).toggleClass('btn-warning btn-danger').html('<i class="fad fa-trash-alt"></i> Are you sure?');
            var x = $('#ID').val();
            var t = $(this).data('type');
            $(this).on('click', function() {
                $.ajax({
                    url: 'assets/CFCs/functions.cfc',
                    type: 'GET',
                    dataType: 'json',
                    data: { method: "MGTT32", MGT_TYPE: 'soft_delete', ID: x },
                    success: function(data) {
                        $('#t32Modal').modal('hide');
                        reLoadT32()
                    }
                });
            });
        });

        $('#update').on('click', function() {
            alert('Click Boom')
            var x = $('#ID').val();
            var cfs = $('#cfs').val();
            var vendorname = $('#vendorname').val();
            var vendorID = $('#vendorID').val();
            var emplid = $('#emplid').val();
            var expensed_date = $('#expensed_date').val();
            var requisition_date = $('#requisition_date').val();
            var notes = $('#notes').val();
            var debit = $('#debit').val();
            var credit = $('#credit').val();
            var type = $('#type').val();
            console.log(x, cfs, vendorname, vendorID, emplid, expensed_date, requisition_date, notes, debit, credit, type)
            $.ajax({
                url: 'assets/CFCs/functions.cfc',
                type: 'GET',
                dataType: 'json',
                data: { method: "MGTT32", MGT_TYPE: 'edit', ID: x, CFS: cfs, VENDORNAME: vendorname, VENDORID: vendorID, EMPLID: emplid, EXPENSED_DATE: expensed_date, REQUISITION_DATE: requisition_date, NOTES: notes, DEBIT: debit, CREDIT: credit, TRANSACTION_TYPE: type },
                success: function(data) {
                    $('#t32Modal').modal('hide');
                    reLoadT32()
                }
            });
        });

        $('#save').on('click', function() {
            var cfs = $('#cfs').val();
            var vendorname = $('#vendorname').val();
            var vendorID = $('#vendorID').val();
            var emplid = $('#emplid').val();
            var expensed_date = $('#expensed_date').val();
            var requisition_date = $('#requisition_date').val();
            var notes = $('#notes').val();
            var debit = $('#debit').val();
            var credit = $('#credit').val();
            var type = $('#type').val();
            console.log(cfs, vendorname, vendorID, emplid, expensed_date, requisition_date, notes, debit, credit, type)
            $.ajax({
                url: 'assets/CFCs/functions.cfc',
                type: 'GET',
                dataType: 'json',
                data: { method: "MGTT32", MGT_TYPE: 'add', CFS: cfs, VENDORNAME: vendorname, VENDORID: vendorID, EMPLID: emplid, EXPENSED_DATE: expensed_date, REQUISITION_DATE: requisition_date, NOTES: notes, DEBIT: debit, CREDIT: credit, TYPE: type },
                success: function(data) {
                    $('#t32Modal').modal('hide');
                    reLoadT32()
                }
            });
        });

        $('#type').change(function(){
            var txt = $(this).val();
            $("input[disabled]").removeAttr("disabled");
            $("textarea[disabled]").removeAttr("disabled");
            $("select[disabled]").removeAttr("disabled");
            $('.title').html(txt);
            if($(this).val() == 'Travel'){
                $('.reqDate').html('TRAVEL DATE');
            }else{
                $('.reqDate').html('REQUISITION DATE');
            }
        });
    });
    function loadT32(){
        //create HTML table for T32-Checkbook
        var tbl = '';
            tbl += '<div class="card mt-3">';
            tbl += '<div class="card-body">';
            tbl += '<div class="row">';
            tbl += '<div class="col">';
            tbl += '<h1>T-32 Checkbook</h1>';
            tbl += '</div>';
            tbl += '</div>';
            tbl += '</div>';
            tbl += '</div>';

            tbl += '<div class="card mt-1 mb-2">';
            tbl += '<div class="card-body">';


            tbl += '<table id="T32Tbl" class="table table-striped table-bordered table-hover" style="margin-top:10px;">';
            tbl += '<thead>';
            tbl += '<tr>';
            tbl += '<th>ID</th>';
            tbl += '<th>CFS</th>';
            tbl += '<th>VENDORNAME</th>';
            tbl += '<th>VENDORID</th>';
            tbl += '<th>EMPLID</th>';
            tbl += '<th>EXPENSED_DATE</th>';
            tbl += '<th>REQUISITION_DATE</th>';
            tbl += '<th>NOTES</th>';
            tbl += '<th>TYPE</th>';
            tbl += '<th>DEBIT</th>';
            tbl += '<th>CREDIT</th>';
            tbl += '</tr>';
            tbl += '</thead>';
            tbl += '<tbody>';
            tbl += '</tbody>';
            tbl += '</table>';

            tbl += '</div>';
            tbl += '</div>';
            $('#T32').html(tbl);
            $('#T32Tbl thead th').each( function () {
                var title = $(this).text();
                $(this).html( '<input type="text" class="form-control" placeholder="'+title+'" />' );
            });
            loadT32DT();
    }
    function reLoadT32(){
        $('#T32Tbl').DataTable().ajax.reload();
        //reset soft_delete button to default
        $('#soft_delete').removeClass('btn-danger').addClass('btn-warning').html('<i class="fas fa-trash"></i> Delete');
    }
    function loadT32DT(){


        var table =  $('#T32Tbl').DataTable({
            "ajax": "assets/CFCs/functions.cfc?method=getT32",
            "columns": [
                      { data: 'ID' },
                      { data: 'CFS'},
                      { data: 'VENDORNAME' },
                      { data: 'VENDORID' },
                      { data: 'EMPLID' },
                      { data: 'EXPENSED_DATE' },
                      { data: 'REQUISITION_DATE' },
                      { data: 'NOTES' },
                      { data: 'TYPE' },
                      { data: 'DEBIT' },
                      { data: 'CREDIT' }
            ],"order": [[0, "asc"]],
                  "paging": true,
                  "ordering": true,
                  "info": true,
                  "searching": true,
                  //"scrollY": "550px",
                  "scrollCollapse": true,
                  "paging": true,
            "ordering": true,
            pageLength: 5,
            lengthMenu: [10, 25, 50, 75, 100],
            buttons: [
                      { 
                        text: 'Add New', action: function ( e, dt, node, config ) {
                              $('.title').html('');
                              // Logic for adding a new record
                              if ($('#ID').val() != '') {
                                $('#recordID').html('');
                                $('#ID').val('');
                                $('#cfs').val('');
                                $('#vendorname').val('');
                                $('#vendorID').val('');
                                $('#emplid').val('');
                                $('#expensed_date').val();
                                $('#expensed_date').val('');
                                $('#requisition_date').val('');
                                $('#notes').val('');
                                $('#debit').val('');
                                $('#credit').val('');
                                $('#type').val('Select Transaction Type');
                                $("input").attr("disabled",true);
                                $("textarea").attr("disabled",true);
                              }
                              $('#t32Modal').modal('show');
                              $('#save').show();
                              $('#update').hide();
                              $('#soft_delete').hide();
                          },
                          className: 'mb-2'
                      },
                      { 
                        text: 'Download CVS',
                          action: function ( e, dt, node, config ) {
                              var data = table.rows().data();
                              function escapeCSV(value) {
                                  if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                                      return '"' + value.replace(/"/g, '""') + '"';
                                  }
                                  return value;
                              }
                              var csv = 'ID,CFS,VENDORNAME,VENDORID,EMPLID,EXPENSED_DATE,REQUISITION_DATE,NOTES,TYPE,DEBIT,CREDIT,STATUS\n';
                              for (var i = 0; i < data.length; i++) {
                                  csv += escapeCSV(data[i].ID) + ',' + 
                                  escapeCSV(data[i].CFS) + ',' + 
                                  escapeCSV(data[i].VENDORNAME) + ','+
                                  escapeCSV(data[i].VENDORID) + ','+
                                  escapeCSV(data[i].EMPLID) +','+
                                  escapeCSV(data[i].EXPENSED_DATE) +','+
                                  escapeCSV(data[i].REQUISITION_DATE) +','+
                                  escapeCSV(data[i].NOTES) +','+
                                  escapeCSV(data[i].TYPE) +','+
                                  escapeCSV(data[i].DEBIT) +','+
                                  escapeCSV(data[i].CREDIT) +','+
                                  escapeCSV(data[i].STATUS) +'\n'; 
                              }
                              var hiddenElement = document.createElement('a');
                              hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
                              hiddenElement.target = '_blank';
                              hiddenElement.download = 'T32-Checkbook.csv';
                              hiddenElement.click();
                          },
                          className: 'mb-2'
                      },{ text: 'Download Excel',
                          action: function(e, dt, node, config) {
                              var originalData = dt.rows().data().toArray();
                              if (originalData.length === 0) return;
                              var excludeKeys = ['CREATEDBYDATE', 'ENTEREDBYID', 'UPDATEDDATE', 'UPDATEDBYID', 'PRIMARY_BALANCE'];
                              var data = originalData.map(function(obj) {
                                  var newObj = Object.assign({}, obj);
                                  excludeKeys.forEach(function(key) {
                                      delete newObj[key];
                                  });
                                  return newObj;
                              });
                              var headers = ['ID', 'CFS', 'VENDORNAME', 'VENDORID', 'EMPLID', 'EXPENSED_DATE', 'REQUISITION_DATE', 'NOTES', 'TYPE', 'DEBIT', 'CREDIT', 'STATUS'];
                              var wb = XLSX.utils.book_new();
                              var ws = XLSX.utils.json_to_sheet(data, { header: headers });
                              XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                              XLSX.writeFile(wb, 'T32-Checkbook.xlsx');
                          },
                          className: 'mb-2'
                      }
                  ],
                  dom: "Blrtip",
                  select: true
        });
        
        $('#T32Tbl tbody').on('click', 'tr', function() {
              var data = table.row(this).data();
              // Populate the modal with the data if the row is clicked
              //console.log(data)
              $('#recordID').html(data.ID);
              $('#ID').val(data.ID);
              //console.log(data.ID)
              $('#cfs').val(data.CFS);
              $('#vendorname').val(data.VENDORNAME);
              $('#vendorID').val(data.VENDORID);
              $('#emplid').val(data.EMPLID);
              $('#expensed_date').val(moment(data.EXPENSED_DATE).format('YYYY-MM-DD'));
              $('#requisition_date').val(moment(data.REQUISITION_DATE).format('YYYY-MM-DD'));
              $('#notes').val(data.NOTES);
              $('#debit').val(data.DEBIT);
              $('#credit').val(data.CREDIT);
              $('#type').val(data.TYPE);
              //remove disabled from input fields
              $("input[disabled]").removeAttr("disabled");
              $("textarea[disabled]").removeAttr("disabled");
              $('.title').html(data.TYPE);
              $('#soft_delete').attr('data-type',type);

              // Open the modal
              $('#t32Modal').modal('show');
              $('#update').show();
              $('#soft_delete').show();
              $('#save').hide();
          });

            table.columns().every( function () {
                var that = this;
                $( 'input', this.header() ).on( 'keyup change', function () {
                    if ( that.search() !== this.value ) {
                        that.search( this.value ).draw();
                    }
                });
            });
    }
    //Employee search function
function employeeSearch(x) {
        var str = x.split(" ");
        if (/\s/.test(str)) {
            var x = str[1] + '%' + str[0]
        }
        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: "assets/CFCs/functions.cfc",
            data: {
                method: "searchEmployees",
                searchStr: x
            },
            beforeSend: function() {
                $('#searching').html('<span style="color: rgb(59, 91, 152)"><i class="fas fa-spinner fa-spin"></i></span>');
            },
            success: function(response) {
                var x = response.items;
                console.log(x)
                var str = '<div class="list-group">';
                for (var i = 0; i < x.length; i++) {
                    str += '<a href="#"  class="list-group-item list-group-item-action" id="searchResults_' + x[i].emplID + '" phone ="' + x[i].phone + '" location ="' + x[i].location + '" jobTitle ="' + x[i].jobTitle + '" departmentname ="' + x[i].departmentname + '"  username ="' + x[i].username + '" orgcode="' + x[i].orgcode + '" email="' + x[i].email + '" fullName="' + x[i].fullName + '" emplid="' + x[i].emplID + '" display = "' + x[i].fullName + '">(' + x[i].emplID + ') <span style="color:royalblue; font-weight:bold">' + x[i].fullName + '</span> <span style="color:orange">'+x[i].departmentname+'</span></a>';
                }
                str += '</div>';
                $('#results').css({'z-index':'100000','overflow-y':'scroll'}).html(str).show();
                
                $("a[id^='searchResults_'").on('click', function() {
                    var disName = $(this).attr('display');
                    var email = $(this).attr('email');
                    var orgcode = $(this).attr('orgcode');
                    var userid = $(this).attr('username');
                    var emplid = $(this).attr('emplid');
                    var fullName = $(this).attr('fullName');
                    var departmentname = $(this).attr('departmentname');
                    var location = $(this).attr('location');
                    var jobTitle = $(this).attr('jobTitle');
                    var phone = $(this).attr('phone');

                    $('#emplid').val(emplid).attr({
                        'EMPLID': emplid
                    }).focus();
                    $('#vendorname').val(fullName).removeClass('placeholder');
                    $('#vendorID').val(emplid).removeClass('placeholder');

                    $('#EMPLID').html(' ('+emplid+')').removeClass('placeholder');
                    $('#FULL_NAME').html(fullName).removeClass('placeholder').append(' <br> ');
                    $('#JOBTITLE').html(jobTitle).removeClass('placeholder').append(' <br> ');
                    $('#DEPARTMENT').html(departmentname +' ('+orgcode+')').removeClass('placeholder').append(' <br> ');
                    $('#EMAIL_ADDRESS').html(email).removeClass('placeholder').append(' <br> ');
                    $('#LOCATION').html(location).removeClass('placeholder').append(' - ');
                    $('#PHONE').html(phone).removeClass('placeholder');
                    $('#results').hide();
					
                });
            },
            complete: function() {
                $('#searching').html('O');
            }
        })

    }
    function getCFS(){

    }
</script>